/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
import { Component, Input } from '@angular/core';
import { merge, timer } from 'rxjs';
import { debounce, distinctUntilChanged, partition, switchMap } from 'rxjs/operators';
import { PendingInterceptorService } from '../services/pending-interceptor.service';
import { SpinnerVisibilityService } from '../services/spinner-visibility.service';
import { Spinkit } from '../spinkits';
var NgHttpLoaderComponent = /** @class */ (function () {
    function NgHttpLoaderComponent(pendingInterceptorService, spinnerVisibilityService) {
        var _this = this;
        this.pendingInterceptorService = pendingInterceptorService;
        this.spinnerVisibilityService = spinnerVisibilityService;
        this.spinkit = Spinkit;
        this.visibleUntil = Date.now();
        this.spinner = Spinkit.skCubeGrid;
        this.filteredUrlPatterns = [];
        this.filteredMethods = [];
        this.filteredHeaders = [];
        this.debounceDelay = 0;
        this.minDuration = 0;
        this.extraDuration = 0;
        this.entryComponent = null;
        var _a = tslib_1.__read(partition(function (h) { return h; })(this.pendingInterceptorService.pendingRequestsStatus$), 2), showSpinner$ = _a[0], hideSpinner$ = _a[1];
        this.subscriptions = merge(this.pendingInterceptorService.pendingRequestsStatus$.pipe(switchMap(function () { return showSpinner$.pipe(debounce(function () { return timer(_this.debounceDelay); })); })), showSpinner$.pipe(switchMap(function () { return hideSpinner$.pipe(debounce(function () { return _this.getVisibilityTimer(); })); })), this.spinnerVisibilityService.visibilityObservable$)
            .pipe(distinctUntilChanged())
            .subscribe(function (h) { return _this.handleSpinnerVisibility(h); });
    }
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.nullifySpinnerIfEntryComponentIsDefined();
        this.initFilters();
    };
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.subscriptions.unsubscribe();
    };
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.nullifySpinnerIfEntryComponentIsDefined = /**
     * @return {?}
     */
    function () {
        if (null != this.entryComponent) {
            this.spinner = null;
        }
    };
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.initFilters = /**
     * @return {?}
     */
    function () {
        this.initFilteredUrlPatterns();
        this.initFilteredMethods();
        this.initFilteredHeaders();
    };
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.initFilteredUrlPatterns = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (!(this.filteredUrlPatterns instanceof Array)) {
            throw new TypeError('`filteredUrlPatterns` must be an array.');
        }
        if (!!this.filteredUrlPatterns.length) {
            this.filteredUrlPatterns.forEach(function (e) {
                return _this.pendingInterceptorService.filteredUrlPatterns.push(new RegExp(e));
            });
        }
    };
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.initFilteredMethods = /**
     * @return {?}
     */
    function () {
        if (!(this.filteredMethods instanceof Array)) {
            throw new TypeError('`filteredMethods` must be an array.');
        }
        this.pendingInterceptorService.filteredMethods = this.filteredMethods;
    };
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.initFilteredHeaders = /**
     * @return {?}
     */
    function () {
        if (!(this.filteredHeaders instanceof Array)) {
            throw new TypeError('`filteredHeaders` must be an array.');
        }
        this.pendingInterceptorService.filteredHeaders = this.filteredHeaders;
    };
    /**
     * @param {?} showSpinner
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.handleSpinnerVisibility = /**
     * @param {?} showSpinner
     * @return {?}
     */
    function (showSpinner) {
        if (showSpinner) {
            this.visibleUntil = Date.now() + this.minDuration;
        }
        this.isSpinnerVisible = showSpinner;
    };
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.getVisibilityTimer = /**
     * @return {?}
     */
    function () {
        return timer(Math.max(this.extraDuration, this.visibleUntil - Date.now()));
    };
    NgHttpLoaderComponent.decorators = [
        { type: Component, args: [{
                    selector: 'ng-http-loader',
                    template: "<div id=\"spinner\" *ngIf=\"isSpinnerVisible\">\n\n    <ng-container *ngComponentOutlet=\"entryComponent\"></ng-container>\n\n    <sk-cube-grid\n        *ngIf=\"spinner === spinkit.skCubeGrid\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-cube-grid>\n\n    <sk-chasing-dots\n        *ngIf=\"spinner === spinkit.skChasingDots\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-chasing-dots>\n\n    <sk-double-bounce\n        *ngIf=\"spinner === spinkit.skDoubleBounce\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-double-bounce>\n\n    <sk-rotating-plane\n        *ngIf=\"spinner === spinkit.skRotatingPlane\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-rotating-plane>\n\n    <sk-spinner-pulse\n        *ngIf=\"spinner === spinkit.skSpinnerPulse\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-spinner-pulse>\n\n    <sk-three-bounce\n        *ngIf=\"spinner === spinkit.skThreeBounce\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-three-bounce>\n\n    <sk-wandering-cubes\n        *ngIf=\"spinner === spinkit.skWanderingCubes\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-wandering-cubes>\n\n    <sk-wave\n        *ngIf=\"spinner === spinkit.skWave\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-wave>\n\n</div>\n\n",
                    styles: ["#spinner{top:0;left:0;height:100%;width:100%;position:fixed;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:.7;background-color:#f1f1f1}::ng-deep .colored-parent,::ng-deep .colored>div{background-color:#333}"]
                }] }
    ];
    /** @nocollapse */
    NgHttpLoaderComponent.ctorParameters = function () { return [
        { type: PendingInterceptorService },
        { type: SpinnerVisibilityService }
    ]; };
    NgHttpLoaderComponent.propDecorators = {
        backgroundColor: [{ type: Input }],
        spinner: [{ type: Input }],
        filteredUrlPatterns: [{ type: Input }],
        filteredMethods: [{ type: Input }],
        filteredHeaders: [{ type: Input }],
        debounceDelay: [{ type: Input }],
        minDuration: [{ type: Input }],
        extraDuration: [{ type: Input }],
        entryComponent: [{ type: Input }]
    };
    return NgHttpLoaderComponent;
}());
export { NgHttpLoaderComponent };
if (false) {
    /** @type {?} */
    NgHttpLoaderComponent.prototype.isSpinnerVisible;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinkit;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.subscriptions;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.visibleUntil;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.backgroundColor;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinner;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredUrlPatterns;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredMethods;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredHeaders;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.debounceDelay;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.minDuration;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.extraDuration;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.entryComponent;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.pendingInterceptorService;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinnerVisibilityService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctaHR0cC1sb2FkZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctaHR0cC1sb2FkZXIvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9uZy1odHRwLWxvYWRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQVNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUNwRSxPQUFPLEVBQUUsS0FBSyxFQUE0QixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEYsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFDcEYsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDbEYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV0QztJQThCSSwrQkFBb0IseUJBQW9ELEVBQVUsd0JBQWtEO1FBQXBJLGlCQWNDO1FBZG1CLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFBVSw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO1FBdkI3SCxZQUFPLEdBQUcsT0FBTyxDQUFDO1FBRWpCLGlCQUFZLEdBQVcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBS25DLFlBQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDO1FBRTdCLHdCQUFtQixHQUFhLEVBQUUsQ0FBQztRQUVuQyxvQkFBZSxHQUFhLEVBQUUsQ0FBQztRQUUvQixvQkFBZSxHQUFhLEVBQUUsQ0FBQztRQUUvQixrQkFBYSxHQUFHLENBQUMsQ0FBQztRQUVsQixnQkFBVyxHQUFHLENBQUMsQ0FBQztRQUVoQixrQkFBYSxHQUFHLENBQUMsQ0FBQztRQUVsQixtQkFBYyxHQUFRLElBQUksQ0FBQztRQUd4QixJQUFBLG9IQUFrSCxFQUFqSCxvQkFBWSxFQUFFLG9CQUFtRztRQUV4SCxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FDdEIsSUFBSSxDQUFDLHlCQUF5QixDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FDdEQsU0FBUyxDQUFDLGNBQU0sT0FBQSxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFNLE9BQUEsS0FBSyxDQUFDLEtBQUksQ0FBQyxhQUFhLENBQUMsRUFBekIsQ0FBeUIsQ0FBQyxDQUFDLEVBQTVELENBQTRELENBQUMsQ0FDaEYsRUFDRCxZQUFZLENBQUMsSUFBSSxDQUNiLFNBQVMsQ0FBQyxjQUFNLE9BQUEsWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxrQkFBa0IsRUFBRSxFQUF6QixDQUF5QixDQUFDLENBQUMsRUFBNUQsQ0FBNEQsQ0FBQyxDQUNoRixFQUNELElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxxQkFBcUIsQ0FDdEQ7YUFDSSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQzthQUM1QixTQUFTLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxLQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxDQUFDLEVBQS9CLENBQStCLENBQUMsQ0FBQztJQUN6RCxDQUFDOzs7O0lBRUQsd0NBQVE7OztJQUFSO1FBQ0ksSUFBSSxDQUFDLHVDQUF1QyxFQUFFLENBQUM7UUFDL0MsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7Ozs7SUFFRCwyQ0FBVzs7O0lBQVg7UUFDSSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JDLENBQUM7Ozs7SUFFTyx1RUFBdUM7OztJQUEvQztRQUNJLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDN0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7U0FDdkI7SUFDTCxDQUFDOzs7O0lBRU8sMkNBQVc7OztJQUFuQjtRQUNJLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lBQy9CLENBQUM7Ozs7SUFFTyx1REFBdUI7OztJQUEvQjtRQUFBLGlCQVVDO1FBVEcsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixZQUFZLEtBQUssQ0FBQyxFQUFFO1lBQzlDLE1BQU0sSUFBSSxTQUFTLENBQUMseUNBQXlDLENBQUMsQ0FBQztTQUNsRTtRQUVELElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUU7WUFDbkMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxVQUFBLENBQUM7Z0JBQzlCLE9BQUEsS0FBSSxDQUFDLHlCQUF5QixDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUF0RSxDQUFzRSxDQUN6RSxDQUFDO1NBQ0w7SUFDTCxDQUFDOzs7O0lBRU8sbURBQW1COzs7SUFBM0I7UUFDSSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxZQUFZLEtBQUssQ0FBQyxFQUFFO1lBQzFDLE1BQU0sSUFBSSxTQUFTLENBQUMscUNBQXFDLENBQUMsQ0FBQztTQUM5RDtRQUNELElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUMxRSxDQUFDOzs7O0lBRU8sbURBQW1COzs7SUFBM0I7UUFDSSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxZQUFZLEtBQUssQ0FBQyxFQUFFO1lBQzFDLE1BQU0sSUFBSSxTQUFTLENBQUMscUNBQXFDLENBQUMsQ0FBQztTQUM5RDtRQUNELElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUMxRSxDQUFDOzs7OztJQUVPLHVEQUF1Qjs7OztJQUEvQixVQUFnQyxXQUFvQjtRQUNoRCxJQUFJLFdBQVcsRUFBRTtZQUNiLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7U0FDckQ7UUFDRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsV0FBVyxDQUFDO0lBQ3hDLENBQUM7Ozs7SUFFTyxrREFBa0I7OztJQUExQjtRQUNJLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDL0UsQ0FBQzs7Z0JBdEdKLFNBQVMsU0FBQztvQkFDUCxRQUFRLEVBQUUsZ0JBQWdCO29CQUMxQixpekNBQThDOztpQkFFakQ7Ozs7Z0JBUlEseUJBQXlCO2dCQUN6Qix3QkFBd0I7OztrQ0FjNUIsS0FBSzswQkFFTCxLQUFLO3NDQUVMLEtBQUs7a0NBRUwsS0FBSztrQ0FFTCxLQUFLO2dDQUVMLEtBQUs7OEJBRUwsS0FBSztnQ0FFTCxLQUFLO2lDQUVMLEtBQUs7O0lBNEVWLDRCQUFDO0NBQUEsQUF2R0QsSUF1R0M7U0FsR1kscUJBQXFCOzs7SUFDOUIsaURBQWlDOztJQUNqQyx3Q0FBeUI7O0lBQ3pCLDhDQUFvQzs7SUFDcEMsNkNBQTBDOztJQUUxQyxnREFDK0I7O0lBQy9CLHdDQUNvQzs7SUFDcEMsb0RBQzBDOztJQUMxQyxnREFDc0M7O0lBQ3RDLGdEQUNzQzs7SUFDdEMsOENBQ3lCOztJQUN6Qiw0Q0FDdUI7O0lBQ3ZCLDhDQUN5Qjs7SUFDekIsK0NBQ2tDOztJQUV0QiwwREFBNEQ7O0lBQUUseURBQTBEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTXG4gKiBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1JcbiAqIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUlxuICogSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU5cbiAqIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25EZXN0cm95LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IG1lcmdlLCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIHRpbWVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZSwgZGlzdGluY3RVbnRpbENoYW5nZWQsIHBhcnRpdGlvbiwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUGVuZGluZ0ludGVyY2VwdG9yU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3BlbmRpbmctaW50ZXJjZXB0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBTcGlubmVyVmlzaWJpbGl0eVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9zcGlubmVyLXZpc2liaWxpdHkuc2VydmljZSc7XG5pbXBvcnQgeyBTcGlua2l0IH0gZnJvbSAnLi4vc3BpbmtpdHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ25nLWh0dHAtbG9hZGVyJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vbmctaHR0cC1sb2FkZXIuY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL25nLWh0dHAtbG9hZGVyLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTmdIdHRwTG9hZGVyQ29tcG9uZW50IGltcGxlbWVudHMgT25EZXN0cm95LCBPbkluaXQge1xuICAgIHB1YmxpYyBpc1NwaW5uZXJWaXNpYmxlOiBib29sZWFuO1xuICAgIHB1YmxpYyBzcGlua2l0ID0gU3BpbmtpdDtcbiAgICBwcml2YXRlIHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbjtcbiAgICBwcml2YXRlIHZpc2libGVVbnRpbDogbnVtYmVyID0gRGF0ZS5ub3coKTtcblxuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGJhY2tncm91bmRDb2xvcjogc3RyaW5nO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIHNwaW5uZXIgPSBTcGlua2l0LnNrQ3ViZUdyaWQ7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZmlsdGVyZWRVcmxQYXR0ZXJuczogc3RyaW5nW10gPSBbXTtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBmaWx0ZXJlZE1ldGhvZHM6IHN0cmluZ1tdID0gW107XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZmlsdGVyZWRIZWFkZXJzOiBzdHJpbmdbXSA9IFtdO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGRlYm91bmNlRGVsYXkgPSAwO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIG1pbkR1cmF0aW9uID0gMDtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBleHRyYUR1cmF0aW9uID0gMDtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBlbnRyeUNvbXBvbmVudDogYW55ID0gbnVsbDtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcGVuZGluZ0ludGVyY2VwdG9yU2VydmljZTogUGVuZGluZ0ludGVyY2VwdG9yU2VydmljZSwgcHJpdmF0ZSBzcGlubmVyVmlzaWJpbGl0eVNlcnZpY2U6IFNwaW5uZXJWaXNpYmlsaXR5U2VydmljZSkge1xuICAgICAgICBjb25zdCBbc2hvd1NwaW5uZXIkLCBoaWRlU3Bpbm5lciRdID0gcGFydGl0aW9uKChoOiBib29sZWFuKSA9PiBoKSh0aGlzLnBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UucGVuZGluZ1JlcXVlc3RzU3RhdHVzJCk7XG5cbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbWVyZ2UoXG4gICAgICAgICAgICB0aGlzLnBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UucGVuZGluZ1JlcXVlc3RzU3RhdHVzJC5waXBlKFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiBzaG93U3Bpbm5lciQucGlwZShkZWJvdW5jZSgoKSA9PiB0aW1lcih0aGlzLmRlYm91bmNlRGVsYXkpKSkpXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgc2hvd1NwaW5uZXIkLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKCgpID0+IGhpZGVTcGlubmVyJC5waXBlKGRlYm91bmNlKCgpID0+IHRoaXMuZ2V0VmlzaWJpbGl0eVRpbWVyKCkpKSlcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICB0aGlzLnNwaW5uZXJWaXNpYmlsaXR5U2VydmljZS52aXNpYmlsaXR5T2JzZXJ2YWJsZSQsXG4gICAgICAgIClcbiAgICAgICAgICAgIC5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKGggPT4gdGhpcy5oYW5kbGVTcGlubmVyVmlzaWJpbGl0eShoKSk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMubnVsbGlmeVNwaW5uZXJJZkVudHJ5Q29tcG9uZW50SXNEZWZpbmVkKCk7XG4gICAgICAgIHRoaXMuaW5pdEZpbHRlcnMoKTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBudWxsaWZ5U3Bpbm5lcklmRW50cnlDb21wb25lbnRJc0RlZmluZWQoKTogdm9pZCB7XG4gICAgICAgIGlmIChudWxsICE9IHRoaXMuZW50cnlDb21wb25lbnQpIHtcbiAgICAgICAgICAgIHRoaXMuc3Bpbm5lciA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGluaXRGaWx0ZXJzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmluaXRGaWx0ZXJlZFVybFBhdHRlcm5zKCk7XG4gICAgICAgIHRoaXMuaW5pdEZpbHRlcmVkTWV0aG9kcygpO1xuICAgICAgICB0aGlzLmluaXRGaWx0ZXJlZEhlYWRlcnMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGluaXRGaWx0ZXJlZFVybFBhdHRlcm5zKCk6IHZvaWQge1xuICAgICAgICBpZiAoISh0aGlzLmZpbHRlcmVkVXJsUGF0dGVybnMgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2BmaWx0ZXJlZFVybFBhdHRlcm5zYCBtdXN0IGJlIGFuIGFycmF5LicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEhdGhpcy5maWx0ZXJlZFVybFBhdHRlcm5zLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFVybFBhdHRlcm5zLmZvckVhY2goZSA9PlxuICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ0ludGVyY2VwdG9yU2VydmljZS5maWx0ZXJlZFVybFBhdHRlcm5zLnB1c2gobmV3IFJlZ0V4cChlKSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGluaXRGaWx0ZXJlZE1ldGhvZHMoKTogdm9pZCB7XG4gICAgICAgIGlmICghKHRoaXMuZmlsdGVyZWRNZXRob2RzIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdgZmlsdGVyZWRNZXRob2RzYCBtdXN0IGJlIGFuIGFycmF5LicpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucGVuZGluZ0ludGVyY2VwdG9yU2VydmljZS5maWx0ZXJlZE1ldGhvZHMgPSB0aGlzLmZpbHRlcmVkTWV0aG9kcztcbiAgICB9XG5cbiAgICBwcml2YXRlIGluaXRGaWx0ZXJlZEhlYWRlcnMoKTogdm9pZCB7XG4gICAgICAgIGlmICghKHRoaXMuZmlsdGVyZWRIZWFkZXJzIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdgZmlsdGVyZWRIZWFkZXJzYCBtdXN0IGJlIGFuIGFycmF5LicpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucGVuZGluZ0ludGVyY2VwdG9yU2VydmljZS5maWx0ZXJlZEhlYWRlcnMgPSB0aGlzLmZpbHRlcmVkSGVhZGVycztcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVNwaW5uZXJWaXNpYmlsaXR5KHNob3dTcGlubmVyOiBib29sZWFuKTogdm9pZCB7XG4gICAgICAgIGlmIChzaG93U3Bpbm5lcikge1xuICAgICAgICAgICAgdGhpcy52aXNpYmxlVW50aWwgPSBEYXRlLm5vdygpICsgdGhpcy5taW5EdXJhdGlvbjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmlzU3Bpbm5lclZpc2libGUgPSBzaG93U3Bpbm5lcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFZpc2liaWxpdHlUaW1lcigpOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgICAgICByZXR1cm4gdGltZXIoTWF0aC5tYXgodGhpcy5leHRyYUR1cmF0aW9uLCB0aGlzLnZpc2libGVVbnRpbCAtIERhdGUubm93KCkpKTtcbiAgICB9XG59XG4iXX0=